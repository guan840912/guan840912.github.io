<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Neil Kuan">
  
  
  
  <link rel="prev" href="https://blog.neilkuan.dev/2020/aws-iam-role-for-eks-service-account/" />
  <link rel="next" href="https://blog.neilkuan.dev/2020/aws_s3_private_endpoint/" />
  <link rel="canonical" href="https://blog.neilkuan.dev/2020/certbot_lets_encrypt_create_ca_aws_route53/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Let’s Encrypt | Neil Blog
       
  </title>
  <meta name="title" content="Let’s Encrypt | Neil Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/blog.neilkuan.dev\/"
    },
    "articleSection" : "posts",
    "name" : "Let’s Encrypt",
    "headline" : "Let’s Encrypt",
    "description" : "小弟的域名雖然託管在 Route53 上面 ，也知道 AWS 也有提供 ACM 搭配 ELB 憑證託管的免費方案，但有時候申請幾張 憑證來用是相當實用的。\nLet’s Encrypt 的數位憑證認證機構（CA）推出免費 SSL\/TLS 憑證服務，也在年底正式對外開放。這是什麼呢？簡單來說，以往想為你的網站加入 SSL 加密協定（HTTPS，也就是網址列上的綠色鎖頭圖示），必須支付一筆費用來申請憑證，但有了 Let’s Encrypt 後將能免費申請憑證，且這一過程非常簡單、自動化。\n 值得注意的是 Let’s Encrypt 提供的憑證只有90天，每60天可以更新(renew)憑證。 Certbot 提供相當完整的安裝指引，到 https:\/\/certbot.eff.org\/ 來做到自動化的更新憑證。\n 並且 Certbot 還有提供 docker image 使安裝 Certbot 更快速且簡單，不會污染到環境。\ndocker hub https:\/\/hub.docker.com\/r\/certbot\/dns-route53\n因為我的domain 託管在 Route53 Certbot 更是有提供搭配 route 53 驗證憑證的方法，更有可以調用 route53 驗證 ，給予憑證的 role or iam user 需要的 IAM Policy 如下：\n{ \u0026#34;Version\u0026#34;: \u0026#34;2012-10-17\u0026#34;, \u0026#34;Id\u0026#34;: \u0026#34;certbot-dns-route53 sample policy\u0026#34;, \u0026#34;Statement\u0026#34;: [ { \u0026#34;Effect\u0026#34;: \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34;: [ \u0026#34;route53:ListHostedZones\u0026#34;, \u0026#34;route53:GetChange\u0026#34; ], \u0026#34;Resource\u0026#34;: [ \u0026#34;*\u0026#34; ] }, { \u0026#34;Effect\u0026#34; : \u0026#34;Allow\u0026#34;, \u0026#34;Action\u0026#34; : [ \u0026#34;route53:ChangeResourceRecordSets\u0026#34; ], \u0026#34;Resource\u0026#34; : [ \u0026#34;arn:aws:route53:::hostedzone\/YOURHOSTEDZONEID\u0026#34; \u0026lt;- 要換成您的 ] } ] } Certbot-route53 docs https:\/\/certbot-dns-route53.",
    "inLanguage" : "en-us",
    "author" : "NeilKuan",
    "creator" : "NeilKuan",
    "publisher": "NeilKuan",
    "accountablePerson" : "NeilKuan",
    "copyrightHolder" : "NeilKuan",
    "copyrightYear" : "2020",
    "datePublished": "2020-05-17 10:00:00 \u002b0000 UTC",
    "dateModified" : "2020-05-17 10:00:00 \u002b0000 UTC",
    "url" : "https:\/\/blog.neilkuan.dev\/2020\/certbot_lets_encrypt_create_ca_aws_route53\/",
    "wordCount" : "305",
    "keywords" : [ "CA","AWS","Route53", "Neil Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://blog.neilkuan.dev/">Neil Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://blog.neilkuan.dev/">Neil Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Let’s Encrypt</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://blog.neilkuan.dev/" rel="author">NeilKuan</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-05-17 itemprop="datePublished">May 17, 2020</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        

        <img src="/posts/ca-01.png" class="featured_image">
        
        
     
          
          
          

          
          
          

          <p>小弟的域名雖然託管在 Route53 上面 ，也知道 AWS 也有提供 ACM 搭配 ELB 憑證託管的免費方案，但有時候申請幾張 憑證來用是相當實用的。</p>
<p><a href="https://letsencrypt.org/">Let’s Encrypt</a> 的數位憑證認證機構（<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81%E6%9C%BA%E6%9E%84">CA</a>）推出<strong>免費 SSL/TLS  憑證</strong>服務，也在年底正式對外開放。這是什麼呢？簡單來說，以往想為你的網站加入 SSL 加密協定（<a href="https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE">HTTPS</a>，也就是網址列上的綠色鎖頭圖示），必須支付一筆費用來申請憑證，但有了 Let’s Encrypt 後將能免費申請憑證，且這一過程非常簡單、自動化。</p>
<blockquote>
<p>值得注意的是 Let’s Encrypt 提供的憑證只有90天，每60天可以更新(renew)憑證。
Certbot 提供相當完整的安裝指引，到 <a href="https://certbot.eff.org/">https://certbot.eff.org/</a> 來做到自動化的更新憑證。</p>
</blockquote>
<p>並且 <strong>Certbot</strong> 還有提供 docker image 使安裝 Certbot 更快速且簡單，不會污染到環境。</p>
<h2 id="docker-hub">docker hub</h2>
<p><a href="https://hub.docker.com/r/certbot/dns-route53">https://hub.docker.com/r/certbot/dns-route53</a></p>
<p>因為我的domain 託管在 Route53 Certbot 更是有提供搭配 route 53 驗證憑證的方法，更有可以調用 route53 驗證 ，給予憑證的 role or iam user 需要的 <strong>IAM Policy</strong> 如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
    <span style="color:#e6db74">&#34;Id&#34;</span>: <span style="color:#e6db74">&#34;certbot-dns-route53 sample policy&#34;</span>,
    <span style="color:#e6db74">&#34;Statement&#34;</span>: <span style="color:#f92672">[</span>
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#e6db74">&#34;Action&#34;</span>: <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;route53:ListHostedZones&#34;</span>,
                <span style="color:#e6db74">&#34;route53:GetChange&#34;</span>
            <span style="color:#f92672">]</span>,
            <span style="color:#e6db74">&#34;Resource&#34;</span>: <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;*&#34;</span>
            <span style="color:#f92672">]</span>
        <span style="color:#f92672">}</span>,
        <span style="color:#f92672">{</span>
            <span style="color:#e6db74">&#34;Effect&#34;</span> : <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#e6db74">&#34;Action&#34;</span> : <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;route53:ChangeResourceRecordSets&#34;</span>
            <span style="color:#f92672">]</span>,
            <span style="color:#e6db74">&#34;Resource&#34;</span> : <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;arn:aws:route53:::hostedzone/YOURHOSTEDZONEID&#34;</span>  &lt;- 要換成您的
            <span style="color:#f92672">]</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="certbot-route53-docs">Certbot-route53 docs</h2>
<p><a href="https://certbot-dns-route53.readthedocs.io/en/stable/">https://certbot-dns-route53.readthedocs.io/en/stable/</a></p>
<blockquote>
<p>現在假設您的執行環境是 EC2 (ubuntu) , EC2 的 IAM Role 也已 attach 上述的 IAM Policy 。
# run image and set .aws default config in container</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ docker run -it --rm  --entrypoint ash certbot/dns-route53

<span style="color:#75715e"># 將YOUR_DOMAIN 換成您拖管在 route53 的 domain name , YOUR_EMAIL 換成您的 Email。</span>
<span style="color:#75715e"># 進入 container 內。</span>
certbot certonly --agree-tos <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --dns-route53 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   --dns-route53-propagation-seconds <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>   -d *.<span style="color:#e6db74">${</span>YOUR_DOMAIN<span style="color:#e6db74">}</span> -m <span style="color:#e6db74">${</span>YOUR_EMAIL<span style="color:#e6db74">}</span> --eff-email 

<span style="color:#75715e"># 等待大概 30 s </span>
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Found credentials in shared credentials file: ~/.aws/credentials
Plugins selected: Authenticator dns-route53, Installer None
Obtaining a new certificate
Performing the following challenges:
dns-01 challenge <span style="color:#66d9ef">for</span> example.com
Waiting <span style="color:#66d9ef">for</span> verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/<span style="color:#e6db74">${</span>YOUR_DOMAIN<span style="color:#e6db74">}</span>/fullchain.pem   &lt;- 憑證在這
   Your key file has been saved at:
   /etc/letsencrypt/live/<span style="color:#e6db74">${</span>YOUR_DOMAIN<span style="color:#e6db74">}</span>/privkey.pem     &lt;- key 在這
   Your cert will expire on 2020-08-15. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   <span style="color:#e6db74">&#34;certbot renew&#34;</span>
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let<span style="color:#960050;background-color:#1e0010">&#39;</span>s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/letsencrypt/live/<span style="color:#e6db74">${</span>YOUR_DOMAIN<span style="color:#e6db74">}</span>/fullchain.pem   &lt;- 憑證在這
Your key file has been saved at:
/etc/letsencrypt/live/<span style="color:#e6db74">${</span>YOUR_DOMAIN<span style="color:#e6db74">}</span>/privkey.pem     &lt;- key 在這
</code></pre></div><p>然後再把 憑證複製出來即可 。</p>
<p>2020年5月17日 Neil Kuan</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Neil Kuan </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://blog.neilkuan.dev/2020/certbot_lets_encrypt_create_ca_aws_route53/>https://blog.neilkuan.dev/2020/certbot_lets_encrypt_create_ca_aws_route53/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/ca/">
                    #CA</a></span>
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/aws/">
                    #AWS</a></span>
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/route53/">
                    #Route53</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://blog.neilkuan.dev/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://blog.neilkuan.dev/2020/aws-iam-role-for-eks-service-account/" class="prev" rel="prev" title="Least privilege ?! IAM Role For Service Account (IRSA)"><i class="iconfont icon-left"></i>&nbsp;Least privilege ?! IAM Role For Service Account (IRSA)</a>
         
        
        <a href="https://blog.neilkuan.dev/2020/aws_s3_private_endpoint/" class="next" rel="next" title="AWS S3 Private endpoint">AWS S3 Private endpoint&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://blog.neilkuan.dev/">Neil Kuan</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
