<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Neil Kuan">
  
  
  
  <link rel="prev" href="https://blog.neilkuan.dev/2020/cdk_for_terraform_amazing_docker/" />
  <link rel="next" href="https://blog.neilkuan.dev/2020/github-container-registry/" />
  <link rel="canonical" href="https://blog.neilkuan.dev/2020/building-docker-images-with-kaniko/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           Building Docker images with Kaniko !!! | Neil Blog
       
  </title>
  <meta name="title" content="Building Docker images with Kaniko !!! | Neil Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/blog.neilkuan.dev\/"
    },
    "articleSection" : "posts",
    "name" : "Building Docker images with Kaniko !!!",
    "headline" : "Building Docker images with Kaniko !!!",
    "description" : "Kaniko !!! Building Docker images with Kaniko kaniko is a tool to build container images from a Dockerfile, inside a container or Kubernetes cluster. kaniko solves two problems with using the Docker-in-Docker build method:\n Docker-in-Docker requires privileged mode in order to function, which is a significant security concern. Docker-in-Docker generally incurs a performance penalty and can be quite slow.  When building an image with kaniko and CI\/CD, you should be aware of a few important details:",
    "inLanguage" : "en-us",
    "author" : "NeilKuan",
    "creator" : "NeilKuan",
    "publisher": "NeilKuan",
    "accountablePerson" : "NeilKuan",
    "copyrightHolder" : "NeilKuan",
    "copyrightYear" : "2020",
    "datePublished": "2020-08-04 00:00:00 \u002b0000 UTC",
    "dateModified" : "2020-08-04 00:00:00 \u002b0000 UTC",
    "url" : "https:\/\/blog.neilkuan.dev\/2020\/building-docker-images-with-kaniko\/",
    "wordCount" : "461",
    "keywords" : [ "CICD","DOCKER","Kaniko", "Neil Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://blog.neilkuan.dev/">Neil Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://blog.neilkuan.dev/">Neil Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Building Docker images with Kaniko !!!</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://blog.neilkuan.dev/" rel="author">NeilKuan</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-08-04 itemprop="datePublished">August 4, 2020</time>
                </span>
                in
                
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        <img src="/posts/20200804-kaniko/1-kaniko.png" class="featured_image">
        
        
     
          
          
          

          
          
          

          <h1 id="kaniko-">Kaniko !!!</h1>
<h1 id="building-docker-images-with-kaniko">Building Docker images with Kaniko</h1>
<p><a href="https://github.com/GoogleContainerTools/kaniko">kaniko</a> is a tool to build container images from a Dockerfile, inside a container or Kubernetes cluster.
kaniko solves two problems with using the <a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-workflow-with-docker-executor">Docker-in-Docker build</a> method:</p>
<ul>
<li>Docker-in-Docker requires <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">privileged mode</a> in order to function, which is a significant security concern.</li>
<li>Docker-in-Docker generally incurs a performance penalty and can be quite slow.</li>
</ul>
<p>When building an image with kaniko and CI/CD, you should be aware of a few important details:</p>
<ul>
<li>The kaniko debug image is recommended (<code>gcr.io/kaniko-project/executor:debug</code>) because it has a shell, and a shell is required for an image to be used with GitLab CI/CD.</li>
<li>The entrypoint will need to be <a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html#overriding-the-entrypoint-of-an-image">overridden</a>, otherwise the build script will not run.</li>
<li>A Docker <code>config.json</code> file needs to be created with the authentication information for the desired container registry.</li>
</ul>
<p>簡化來說 ， 使用 docker build 時 最要不得的就是要， mount /var/run/docker.sock 這個 sock 到 build container 內，這使得 build container 需要 <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">privileged mode</a> ， 為了解決這個問題 ， google 在 2018 年六月開啟了 <a href="https://github.com/GoogleContainerTools/kaniko">kaniko</a> 專案 來解決這個問題  ， 目前 release 到 v.0.24.0 版</p>
<p><img src="/posts/20200804-kaniko/2-kaniko-repo.png" alt=""></p>
<h1 id="如何使用">如何使用</h1>
<p><strong>env:</strong></p>
<ul>
<li>Docker version 1.13.1, build 7f2769b/1.13.1</li>
<li>centos 7</li>
</ul>
<p>可以使用 docker run 調用:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -it gcr.io/kaniko-project/executor:latest --help
</code></pre></div><p>它在默認的 <strong>container</strong> 內 <code>/workspace</code> 目錄下尋找 <code>Dockerfile</code>，並且通過<code>-d</code> flag 來設定將要推送的<code>registry name</code> and <code>image name</code> , <code>image:tag</code>。</p>
<p><strong>創建資料夾</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir ~/kaniko-example
cd kaniko-example
vi Dockerfile
mkdir nginx 
vi nginx/default.conf
</code></pre></div><p><strong>sample Dockerfile</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">FROM nginx:alpine
LABEL github-action<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GCR&#34;</span>
LABEL NAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nginx-gcr&#34;</span>
LABEL Version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.1&#34;</span>
COPY nginx/default.conf /etc/nginx/conf.d/default.conf
EXPOSE <span style="color:#ae81ff">8080</span>
</code></pre></div><p><strong>sample default.conf</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">server <span style="color:#f92672">{</span>
    listen        8080;
    server_name   localhost;
    location / <span style="color:#f92672">{</span>
        root      /usr/share/nginx/html;
        index     index.html index.htm;
    <span style="color:#f92672">}</span>

    <span style="color:#75715e"># redirect server error pages to the static page /50x.html</span>
    error_page    <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">502</span> <span style="color:#ae81ff">503</span> <span style="color:#ae81ff">504</span>  /50x.html;
    location <span style="color:#f92672">=</span> /50x.html <span style="color:#f92672">{</span>
        root      /usr/share/nginx/html;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>為了能夠將生成的 <code>image</code> 推送到遠方 <code>Docker Registry</code> ，您需要使 <code>credentials token</code> 據在 <strong>kaniko container</strong> 中可用。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># docker login 預設 login 到 docker hub </span>

docker login 

<span style="color:#75715e"># 我們可以看一下發現 其實他也就是 username:password | base64 過後的檔案而已  </span>
cat ~/.docker/config.conf
<span style="color:#75715e">#############################use admin:admin base64 過後 ###########################</span>
<span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;auths&#34;</span>: <span style="color:#f92672">{</span>
                <span style="color:#e6db74">&#34;https://index.docker.io/v1/&#34;</span>: <span style="color:#f92672">{</span>
                        <span style="color:#e6db74">&#34;auth&#34;</span>: <span style="color:#e6db74">&#34;YWRtaW46YWRtaW4K&#34;</span>
                <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>使用 <code>docker version (``[v17.03.0-ce](https://github.com/docker/docker/releases/tag/v17.03.0-ce)``)</code> 的朋友 ， 因為有了<code>credsStore</code> or <code>credential-helper</code> 來保管 <code>credential</code>
建議 自己將 <code>username:password</code> base64 後，替換 掉 <code>YWRtaW46YWRtaW4K</code></p>
<pre><code>echo username:password | base64 
</code></pre>
<p><a href="https://github.com/spotify/docker-client/issues/657">see issue</a></p>
<p>當前資料夾目錄結構</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls -lR ~/kaniko-example
total <span style="color:#ae81ff">32</span>
-rw-r--r--  <span style="color:#ae81ff">1</span> neilguan  staff    <span style="color:#ae81ff">155</span>  <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">31</span> 17:32 Dockerfile
-rw-r--r--  <span style="color:#ae81ff">1</span> neilguan  staff  <span style="color:#ae81ff">11357</span>  <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">31</span> 16:15 LICENSE
drwxr-xr-x  <span style="color:#ae81ff">3</span> neilguan  staff     <span style="color:#ae81ff">96</span>  <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">31</span> 16:23 nginx

./nginx:
total <span style="color:#ae81ff">8</span>
-rw-r--r--  <span style="color:#ae81ff">1</span> neilguan  staff  <span style="color:#ae81ff">352</span>  <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">31</span> 16:23 default.conf
</code></pre></div><h2 id="lets-do-it-">Let’s do it ~~</h2>
<p>現在本地目錄 <code>~/kaniko-example</code> 中有一個Dockerfile。
您可以使用以下命令構建並推送Docker映像（替換&lt;username/image-name:tag&gt;…）：
我們將會把 家目錄的 <code>.docker/config.json</code> 掛入 container 內的 <code>/kaniko/config.json</code>
設置 container 環境變數  <code>DOCKER_CONFIG=/kaniko</code>
指定 <code>-f</code> <strong>Dockerfile</strong> 路徑 並設定 目的地 ～</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd ~/kaniko-example

docker run -it -v ~/.docker/config.json:/kaniko/config.json <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -v $PWD:/workspace -e DOCKER_CONFIG<span style="color:#f92672">=</span>/kaniko <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        gcr.io/kaniko-project/executor:latest <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -f /workspace/Dockerfile <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -d &lt;username/image-name:tag&gt;
</code></pre></div><p><img src="/posts/20200804-kaniko/3-kaniko-build.png" alt=""></p>
<p>如果順利 ！？ＸＤ
你可以到你的 docker hub 看到您透過 kaniko build and push 的 image :</p>
<p><img src="/posts/20200804-kaniko/4-dockerhub.png" alt=""></p>
<p>更可以將 他整合到 ci/cd pipeline 中
gitlab 已有很好的 example</p>
<p><strong>Building images with kaniko and GitLab CI/CD</strong>
<a href="https://docs.gitlab.com/ee/ci/docker/using_kaniko.html">https://docs.gitlab.com/ee/ci/docker/using_kaniko.html</a></p>
<p>2020年8月04日  Neil Kuan</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Neil Kuan </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://blog.neilkuan.dev/2020/building-docker-images-with-kaniko/>https://blog.neilkuan.dev/2020/building-docker-images-with-kaniko/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/cicd/">
                    #CICD</a></span>
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/docker/">
                    #DOCKER</a></span>
            
            <span class="tag"><a href="https://blog.neilkuan.dev/tags/kaniko/">
                    #Kaniko</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://blog.neilkuan.dev/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://blog.neilkuan.dev/2020/cdk_for_terraform_amazing_docker/" class="prev" rel="prev" title="CDK for Terraform Amazing"><i class="iconfont icon-left"></i>&nbsp;CDK for Terraform Amazing</a>
         
        
        <a href="https://blog.neilkuan.dev/2020/github-container-registry/" class="next" rel="next" title="Introducing GitHub Container Registry !!!">Introducing GitHub Container Registry !!!&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2021</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://blog.neilkuan.dev/">Neil Kuan</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
